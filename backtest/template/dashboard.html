<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é‡åŒ–å›æµ‹ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Plotly ç”¨äºç”»å›¾ -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <!-- PapaParse ç”¨äºè§£ææœ¬åœ° CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #020617;
      --border: #1e293b;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --bad: #f97373;
      --good: #4ade80;
      --muted: #6b7280;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 45%, #020617 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1440px;
      margin: 0 auto;
      padding: 16px 20px 32px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      color: var(--accent);
      background: rgba(15, 23, 42, 0.9);
    }

    .subtitle {
      color: var(--text-sub);
      font-size: 12px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .btn {
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, #1e293b 0, #020617 60%, #020617 100%);
      color: var(--text-main);
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
      white-space: nowrap;
    }

    .btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      transform: translateY(-0.5px);
    }

    .btn-primary {
      border-color: var(--accent);
      background: radial-gradient(circle at top left, #0369a1 0, #0f172a 55%, #020617 100%);
    }

    .btn-primary:hover {
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .filename {
      font-size: 11px;
      color: var(--text-sub);
      max-width: 260px;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
      gap: 14px;
      align-items: flex-start;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .card {
      background: rgba(15, 23, 42, 0.98);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .metric {
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid rgba(30, 64, 175, 0.45);
      background: radial-gradient(circle at top left, rgba(30, 64, 175, 0.55) 0, rgba(15, 23, 42, 0.98) 40%, rgba(15, 23, 42, 0.98) 100%);
    }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .metric-value {
      font-size: 14px;
      font-weight: 600;
    }

    .metric-value.good {
      color: var(--good);
    }

    .metric-value.bad {
      color: var(--bad);
    }

    .metric-tag {
      font-size: 10px;
      color: var(--text-sub);
      margin-left: 4px;
    }

    .divider {
      height: 1px;
      border: none;
      background: radial-gradient(to right, transparent, var(--border), transparent);
      margin: 8px 0;
    }

    .tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .tag {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-sub);
    }

    .tag.green {
      border-color: rgba(74, 222, 128, 0.4);
      color: var(--good);
    }

    .tag.yellow {
      border-color: rgba(234, 179, 8, 0.4);
      color: #eab308;
    }

    .tag.red {
      border-color: rgba(248, 113, 113, 0.4);
      color: var(--bad);
    }

    .small {
      font-size: 11px;
      color: var(--text-sub);
    }

    .plot-wrapper {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .plot {
      width: 100%;
      height: 320px;
      border-radius: 16px;
      overflow: hidden;
      background: var(--bg-card);
      border: 1px solid var(--border);
    }

    #status {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <div class="title-block">
        <div class="title">
          é‡åŒ–å›æµ‹ Dashboard
          <span class="badge">æœ¬åœ° CSV å¯è§†åŒ–</span>
        </div>
        <div class="subtitle">
          é€‰æ‹©ç”± <code>export_dashboard_csv</code> å¯¼å‡ºçš„ CSV æ–‡ä»¶ï¼ŒæŸ¥çœ‹èµ„é‡‘æ›²çº¿ã€æŒä»“å’Œæ ¸å¿ƒæŒ‡æ ‡ã€‚
        </div>
      </div>

      <div class="controls">
        <div class="file-input-wrapper">
          <button class="btn btn-primary" type="button">
            <span>ğŸ“‚ é€‰æ‹© dashboard CSV</span>
          </button>
          <input type="file" id="fileInput" accept=".csv" />
        </div>
        <div class="filename" id="filename">å°šæœªé€‰æ‹©æ–‡ä»¶</div>
      </div>
    </div>

    <div class="grid">
      <!-- å·¦ä¾§ï¼šæŒ‡æ ‡é¢æ¿ -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">å›æµ‹æ¦‚å†µ</div>
            <div class="card-subtitle" id="summaryDates">æ—¥æœŸèŒƒå›´ï¼š-</div>
          </div>
        </div>

        <div class="tag-row">
          <span class="tag" id="summarySymbol">æ ‡çš„ï¼š-</span>
          <span class="tag green" id="summaryBars">æ ·æœ¬é•¿åº¦ï¼š-</span>
          <span class="tag yellow" id="summaryFreq">é¢‘ç‡ï¼šæ—¥çº¿</span>
        </div>

        <hr class="divider" />

        <div class="card-subtitle">ç­–ç•¥ vs Buy & Hold</div>
        <div class="metrics-grid" style="margin-top:6px;">
          <!-- ç­–ç•¥ -->
          <div class="metric">
            <div class="metric-label">ç­–ç•¥æ€»æ”¶ç›Š</div>
            <div class="metric-value" id="strTotal">-</div>
            <div class="metric-label">
              å¹´åŒ–æ”¶ç›Š <span class="metric-tag" id="strCagr">-</span>
            </div>
          </div>
          <div class="metric">
            <div class="metric-label">ç­–ç•¥æœ€å¤§å›æ’¤</div>
            <div class="metric-value bad" id="strMdd">-</div>
            <div class="metric-label">
              å¤æ™®ï¼ˆä¼°ç®—ï¼‰<span class="metric-tag" id="strSharpe">-</span>
            </div>
          </div>
          <!-- Buy & Hold -->
          <div class="metric">
            <div class="metric-label">Buy & Hold æ€»æ”¶ç›Š</div>
            <div class="metric-value" id="bhTotal">-</div>
            <div class="metric-label">
              å¹´åŒ–æ”¶ç›Š <span class="metric-tag" id="bhCagr">-</span>
            </div>
          </div>
          <div class="metric">
            <div class="metric-label">Buy & Hold æœ€å¤§å›æ’¤</div>
            <div class="metric-value bad" id="bhMdd">-</div>
            <div class="metric-label">
              è¶…é¢æ”¶ç›Š <span class="metric-tag" id="alphaText">-</span>
            </div>
          </div>
        </div>

        <hr class="divider" />

        <div class="card-subtitle">æŒä»“ä¸é£æ§</div>
        <div class="small" id="positionStats">
          æŒä»“ç»Ÿè®¡ï¼š-
        </div>

        <hr class="divider" />

        <div class="small">
          <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br />
          1. è¿è¡Œå›æµ‹è„šæœ¬ï¼Œç¡®ä¿ç”Ÿæˆ <code>*_dashboard.csv</code><br />
          2. ç‚¹å‡»ä¸Šæ–¹â€œé€‰æ‹© dashboard CSVâ€åŠ è½½æ–‡ä»¶<br />
          3. è‹¥åˆ—åä¸é¢„è®¾ä¸ä¸€è‡´ï¼Œå¯åœ¨ JS é‡Œè°ƒæ•´æ˜ å°„
        </div>

        <div id="status"></div>
      </div>

      <!-- å³ä¾§ï¼šå›¾è¡¨åŒºåŸŸ -->
      <div class="plot-wrapper">
        <div class="card" style="padding:10px 10px 12px;">
          <div class="card-header" style="margin-bottom:4px;">
            <div>
              <div class="card-title">èµ„é‡‘æ›²çº¿</div>
              <div class="card-subtitle">ç­–ç•¥ vs Buy & Hold</div>
            </div>
          </div>
          <div id="equityPlot" class="plot"></div>
        </div>

        <div class="card" style="padding:10px 10px 12px;">
          <div class="card-header" style="margin-bottom:4px;">
            <div>
              <div class="card-title">æŒä»“ä¸ä»·æ ¼</div>
              <div class="card-subtitle">ä»“ä½ï¼ˆæŸ±ï¼‰å åŠ ä»·æ ¼ï¼ˆçº¿ï¼‰</div>
            </div>
          </div>
          <div id="positionPlot" class="plot"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const filenameEl = document.getElementById("filename");
    const statusEl = document.getElementById("status");

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      filenameEl.textContent = file.name;
      statusEl.textContent = "â³ æ­£åœ¨è§£æ CSV ...";

      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => {
          try {
            renderDashboard(results.data);
            statusEl.textContent = "âœ… åŠ è½½å®Œæˆ";
          } catch (err) {
            console.error(err);
            statusEl.textContent = "âŒ è§£æå¤±è´¥ï¼š" + err.message;
          }
        },
        error: (err) => {
          console.error(err);
          statusEl.textContent = "âŒ CSV è§£æé”™è¯¯ï¼š" + err.message;
        },
      });
    });

    function findCol(cols, candidates) {
      for (const c of candidates) {
        if (cols.includes(c)) return c;
      }
      return null;
    }

    function formatPct(x) {
      if (x === null || x === undefined || isNaN(x)) return "-";
      return (x * 100).toFixed(2) + "%";
    }

    function renderDashboard(rows) {
      if (!rows || rows.length === 0) {
        throw new Error("CSV ä¸­æ²¡æœ‰æ•°æ®è¡Œ");
      }

      // æ¸…æ´—ï¼šå»æ‰æ²¡æœ‰ date çš„è¡Œ
      rows = rows.filter((r) => r.date !== undefined && r.date !== null && String(r.date).trim() !== "");
      if (rows.length === 0) {
        throw new Error("æ‰¾ä¸åˆ°åŒ…å« date åˆ—çš„æ•°æ®è¡Œ");
      }

      rows.forEach((r) => {
        r.dateObj = new Date(r.date);
      });

      const cols = Object.keys(rows[0]);

      const equityCol = findCol(cols, ["equity_strategy", "strategy_equity", "equity"]);
      const bhCol = findCol(cols, ["equity_bh", "bh_equity", "equity_bench"]);
      const posCol = findCol(cols, ["position", "raw_position"]);
      const closeCol = findCol(cols, ["close", "price", "close_price"]);

      if (!equityCol) {
        throw new Error("æœªæ‰¾åˆ°ç­–ç•¥èµ„é‡‘åˆ—ï¼ˆå°è¯• `equity_strategy / strategy_equity / equity`ï¼‰");
      }

      // ========== è®¡ç®—æŒ‡æ ‡ ==========
      const n = rows.length;
      const startEq = Number(rows[0][equityCol]);
      const endEq = Number(rows[n - 1][equityCol]);
      const totalRet = startEq > 0 ? endEq / startEq - 1 : NaN;

      const startDate = rows[0].dateObj;
      const endDate = rows[n - 1].dateObj;
      const days = (endDate - startDate) / (1000 * 60 * 60 * 24);
      const years = days / 365.0;
      const cagr = years > 0 && startEq > 0 && endEq > 0 ? Math.pow(endEq / startEq, 1 / years) - 1 : NaN;

      let mdd = NaN;
      {
        const eqArr = rows.map((r) => Number(r[equityCol]));
        let peak = -Infinity;
        let ddMin = 0;
        for (const v of eqArr) {
          if (v > peak) peak = v;
          if (peak > 0) {
            const dd = v / peak - 1;
            if (dd < ddMin) ddMin = dd;
          }
        }
        mdd = ddMin;
      }

      // ç²—ç•¥ä¼°ä¸€ä¸ªå¤æ™®ï¼ˆæŒ‰æ—¥æ”¶ç›Šæ ‡å‡†å·®ï¼‰
      let sharpe = NaN;
      {
        const eqArr = rows.map((r) => Number(r[equityCol]));
        const rets = [];
        for (let i = 1; i < eqArr.length; i++) {
          if (eqArr[i - 1] > 0) {
            rets.push(eqArr[i] / eqArr[i - 1] - 1);
          }
        }
        if (rets.length > 1) {
          const mean = rets.reduce((a, b) => a + b, 0) / rets.length;
          const var_ = rets.reduce((s, r) => s + Math.pow(r - mean, 2), 0) / (rets.length - 1);
          const std = Math.sqrt(var_);
          if (std > 0) {
            sharpe = (mean * 252) / (std * Math.sqrt(252));
          }
        }
      }

      // Buy & Hold æŒ‡æ ‡ï¼ˆå¦‚æœæœ‰ï¼‰
      let bhTotal = NaN,
        bhCagr = NaN,
        bhMdd = NaN;
      if (bhCol) {
        const startBh = Number(rows[0][bhCol]);
        const endBh = Number(rows[n - 1][bhCol]);
        bhTotal = startBh > 0 ? endBh / startBh - 1 : NaN;
        bhCagr = years > 0 && startBh > 0 && endBh > 0 ? Math.pow(endBh / startBh, 1 / years) - 1 : NaN;

        const bhArr = rows.map((r) => Number(r[bhCol]));
        let peakBh = -Infinity;
        let ddMinBh = 0;
        for (const v of bhArr) {
          if (v > peakBh) peakBh = v;
          if (peakBh > 0) {
            const dd = v / peakBh - 1;
            if (dd < ddMinBh) ddMinBh = dd;
          }
        }
        bhMdd = ddMinBh;
      }

      // ========== æ›´æ–°å·¦ä¾§æŒ‡æ ‡ ==========
      document.getElementById("strTotal").textContent = formatPct(totalRet);
      document.getElementById("strTotal").classList.toggle("good", totalRet > 0);
      document.getElementById("strTotal").classList.toggle("bad", totalRet <= 0);
      document.getElementById("strCagr").textContent = formatPct(cagr);
      document.getElementById("strMdd").textContent = formatPct(mdd);
      document.getElementById("strSharpe").textContent = isNaN(sharpe) ? "-" : sharpe.toFixed(2);

      document.getElementById("bhTotal").textContent = formatPct(bhTotal);
      document.getElementById("bhCagr").textContent = formatPct(bhCagr);
      document.getElementById("bhMdd").textContent = formatPct(bhMdd);

      const alpha = !isNaN(totalRet) && !isNaN(bhTotal) ? totalRet - bhTotal : NaN;
      document.getElementById("alphaText").textContent = formatPct(alpha);

      // æ—¥æœŸ & æ ·æœ¬
      const fmtDate = (d) =>
        `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
      document.getElementById("summaryDates").textContent =
        "æ—¥æœŸèŒƒå›´ï¼š" + fmtDate(startDate) + " ~ " + fmtDate(endDate);
      document.getElementById("summaryBars").textContent = `æ ·æœ¬é•¿åº¦ï¼š${n} æ ¹Kçº¿`;

      // symbol è¯•ç€ä»æ–‡ä»¶å / åˆ—é‡ŒçŒœä¸€ä¸‹
      let symbolText = "-";
      if (rows[0].symbol) {
        symbolText = rows[0].symbol;
      }
      document.getElementById("summarySymbol").textContent = "æ ‡çš„ï¼š" + symbolText;

      // ä»“ä½ç»Ÿè®¡
      if (posCol) {
        const posArr = rows.map((r) => Number(r[posCol]) || 0);
        const daysOn = posArr.filter((x) => x > 0).length;
        const ratio = daysOn / posArr.length;
        document.getElementById("positionStats").textContent =
          `æŒä»“å¤©æ•°ï¼š${daysOn} å¤©ï¼Œå æ¯” ${formatPct(ratio)}ï¼›` +
          `å¹³å‡ä»“ä½ï¼ˆç®€å•å¹³å‡ï¼‰ï¼š${formatPct(posArr.reduce((a, b) => a + b, 0) / posArr.length)}`;
      } else {
        document.getElementById("positionStats").textContent = "æŒä»“ç»Ÿè®¡ï¼šæœªæ‰¾åˆ° position åˆ—";
      }

      // ========== ç”»å›¾ï¼šèµ„é‡‘æ›²çº¿ ==========
      const dates = rows.map((r) => r.dateObj);
      const eqTrace = {
        x: dates,
        y: rows.map((r) => r[equityCol]),
        type: "scatter",
        mode: "lines",
        name: "ç­–ç•¥èµ„é‡‘",
        line: { width: 2 },
      };
      const traces = [eqTrace];

      if (bhCol) {
        traces.push({
          x: dates,
          y: rows.map((r) => r[bhCol]),
          type: "scatter",
          mode: "lines",
          name: "Buy & Hold",
          line: { width: 1.8, dash: "dot" },
        });
      }

      Plotly.newPlot("equityPlot", traces, {
        margin: { l: 40, r: 20, t: 16, b: 30 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        xaxis: { showgrid: false },
        yaxis: { showgrid: true, gridcolor: "#1e293b" },
        legend: { orientation: "h", x: 0, y: 1.1 },
      }, { responsive: true });

      // ========== ç”»å›¾ï¼šä»·æ ¼ + ä»“ä½ ==========
      const positionTraces = [];
      if (posCol) {
        positionTraces.push({
          x: dates,
          y: rows.map((r) => r[posCol]),
          type: "bar",
          name: "ä»“ä½",
          yaxis: "y2",
          opacity: 0.4,
        });
      }
      if (closeCol) {
        positionTraces.push({
          x: dates,
          y: rows.map((r) => r[closeCol]),
          type: "scatter",
          mode: "lines",
          name: "æ”¶ç›˜ä»·",
          yaxis: "y1",
          line: { width: 1.5 },
        });
      }

      Plotly.newPlot("positionPlot", positionTraces, {
        margin: { l: 40, r: 40, t: 16, b: 30 },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        xaxis: { showgrid: false },
        yaxis: { showgrid: true, gridcolor: "#1e293b", title: closeCol ? "ä»·æ ¼" : "" },
        yaxis2: {
          overlaying: "y",
          side: "right",
          range: [0, 1.1],
          title: posCol ? "ä»“ä½" : "",
          showgrid: false,
        },
        legend: { orientation: "h", x: 0, y: 1.1 },
      }, { responsive: true });
    }
  </script>
</body>
</html>